<section class="order-confirmation-section">
    <div class="x-max-w-[1440px] x-mx-auto x-p-[16px] md:x-p-[30px]">
        <div class="x-bg-[#FFF6E6] x-flex x-flex-col x-gap-[48px] x-items-center x-justify-center x-text-center x-py-[64px] md:x-py-[80px] lg:x-py-[128px] x-px-[12px] x-text-[16px]">
            <!-- Spinner Container -->
            <div id="spinner-container">
                <div class="loading-spinner">
                    <div class="spinner">
                    </div>
                </div>
            </div>

            <!-- Success Confirmation Content -->
            <div id="confirmation-content" style="display: none;">
                <div><i class='bx bx-check-circle x-text-[#9E0B0F] x-text-[96px]'></i></div>
                <div class="x-text-[32px] md:x-text-[36px]">ORDER CONFIRMED!</div>
                <div>
                    Thank you for placing your order! We hope you enjoyed shopping with us. <br class="x-hidden md:x-block" />
                    We have sent you a confirmation email.
                </div>
                <div class="x-font-semibold">
                    Your order number is: <span id="order-number" class="x-text-[#9E0B0F]"></span>
                </div>
            </div>

            <!-- Failure Content -->
            <div id="failure-content" style="display: none;">
                <div><i class='bx bx-error-circle x-text-[#951828] x-text-[96px]'></i></div>
                <div class="x-text-[32px] md:x-text-[36px]">ORDER FAILED!</div>
                <div>
                    Something went wrong while processing your order. Please try again or view your drafts.
                </div>
            </div>

            <!-- Button -->
            <a id="action-button" style="display: none;" class="x-bg-[#9E0B0F] x-text-white x-text-[14px] md:x-text-[16px] x-p-[12px] md:x-p-[14px] x-px-[16px] md:x-px-[20px] x-uppercase">
                Browse more products
            </a>
        </div>
    </div>
</section>

<style>
    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #ddd;
        border-top: 4px solid #951828;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const params = new URLSearchParams(window.location.search);
    const draftOrderId = params.get('draftOrderId');
    const requestedShipping = params.get('requestedShipping') === 'true';
    const userId = {{customer.id}}; 
    const selectedAddress = {
        addressText: "123 Test St, Test City", 
        province: "Florida",
        country: "United States",
        zip: "32003",
    };

    if (draftOrderId) {
        console.log("Processing Draft Order:", draftOrderId);

        const spinnerContainer = document.getElementById('spinner-container');
        const confirmationContent = document.getElementById('confirmation-content');
        const actionButton = document.getElementById('action-button');

        const tagMutation = `
            mutation {
                createDraftOrderTag(draftOrderId: "${draftOrderId}", tag: "${requestedShipping ? 'ShipRequested' : 'Placed'}", userId: "${userId}")
            }
        `;


        async function requestShipping(draftOrderId, userId, selectedAddress) {
            const mutation = `
                mutation {
                    requestShippingFee(
                        userId: "${userId}",
                        draftOrderId: "${draftOrderId}",
                        shippingAddress: {
                            address1: "${selectedAddress.addressText.split(',')[0] || ''}",
                            city: "${selectedAddress.addressText.split(',')[1] || ''}",
                            province: "${selectedAddress.province || ''}",
                            country: "${selectedAddress.country || ''}",
                            zip: "${selectedAddress.zip || ''}"
                        }
                    )
                }
            `;

            try {
                const response = await fetch("https://f059-158-62-75-42.ngrok-free.app/graphql", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query: mutation }),
                });
                const result = await response.json();

                if (result.data?.requestShippingFee) {
                    console.log("Shipping request sent successfully.");
                } else {
                    alert("Failed to send shipping request email.");
                }
            } catch (error) {
                console.error("Error sending shipping request:", error);
            }
        }

        // Function to tag draft order
        function tagDraftOrder() {
            return $.ajax({
                url: 'https://f059-158-62-75-42.ngrok-free.app/graphql',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ query: tagMutation }),
            });
        }

        // Tag and display confirmation
        tagDraftOrder().done(async function (tagResponse) {
            console.log('Draft Order Tagging Response:', tagResponse);

            if (tagResponse.data?.createDraftOrderTag) {
                if (requestedShipping) {
                    console.log("Shipping fee requested. Triggering requestShipping...");

                    await requestShipping(draftOrderId, userId, selectedAddress);

                    spinnerContainer.style.display = 'none';
                    confirmationContent.innerHTML = `
                        <div><i class='bx bx-check-circle x-text-[#9E0B0F] x-text-[96px]'></i></div>
                        <div class="x-text-[32px] md:x-text-[36px]">SHIPPING FEE REQUESTED!</div>
                        <div>Thank you! Your shipping fee request has been received.</div>
                    `;
                } else {

                    
                    spinnerContainer.style.display = 'none';
                    confirmationContent.innerHTML = `
                        <div><i class='bx bx-check-circle x-text-[#9E0B0F] x-text-[96px]'></i></div>
                        <div class="x-text-[32px] md:x-text-[36px]">ORDER CONFIRMED!</div>
                        <div>
                            Thank you for placing your order! We hope you enjoyed shopping with us. <br class="x-hidden md:x-block" />
                            We have sent you a confirmation email.
                        </div>
                        <div class="x-font-semibold">
                            Your order number is: <span id="order-number" class="x-text-[#9E0B0F]">${draftOrderId.split('/').pop()}</span>
                        </div>
                    `;
                }

                confirmationContent.style.display = 'block';
                actionButton.style.display = 'inline-block';
                actionButton.href = "/account?view=saved";
                actionButton.textContent = "View Saved Orders";
            } else {
                throw new Error("Failed to tag the draft order.");
            }
        }).fail(function (error) {
            console.error('Error tagging draft order:', error.responseJSON || error);
            spinnerContainer.style.display = 'none';
            confirmationContent.innerHTML = `<div class="x-text-[#951828]">Failed to process the draft order. Please try again later.</div>`;
            actionButton.style.display = 'inline-block';
            actionButton.href = "/account?view=saved";
            actionButton.textContent = "Back to Saved Orders";
        });
    } else {
        console.error('No draftOrderId found in URL parameters.');
        alert('No draft order ID provided. Please try again.');
    }
});


</script>

